<!doctype html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Yeni SR Dedektörü</title>

  <style>
    * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  </style>
</head>

<body class="min-h-screen text-slate-900 bg-gradient-to-b from-zinc-100 via-white to-zinc-100 selection:bg-zinc-300 selection:text-zinc-900">

  <!-- VIDEO BACKGROUND (en arkada) -->
  <div class="fixed inset-0 -z-20 overflow-hidden">
    <video
      class="h-full w-full object-cover pointer-events-none"
      style="filter: brightness(1.01) contrast(1.22) saturate(1.32);"
      autoplay
      muted
      loop
      playsinline
      preload="metadata"
    >
    <source src="media/background.mp4" type="video/mp4" />

    </video>

    <!-- tone -->
    <div class="absolute inset-0 bg-black/12"></div>

    <!-- vignette -->
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,rgba(0,0,0,0)_0%,rgba(0,0,0,0.14)_85%)]"></div>
  </div>

  <!-- hafif arkaplan dokusu -->
  <div class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute -top-48 -left-48 h-[520px] w-[520px] rounded-full bg-zinc-100/55 blur-3xl"></div>
    <div class="absolute -bottom-48 -right-48 h-[520px] w-[520px] rounded-full bg-zinc-200/35 blur-3xl"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_0%,rgba(2,6,23,0.06),transparent_45%)] opacity-[0.06]"></div>
  </div>

  <div class="max-w-5xl mx-auto p-6 md:p-10">

    <!-- WELCOME SCREEN -->
    <div id="welcomeScreen" class="min-h-[70vh] grid place-items-center">
      <div
        class="max-w-md w-full mx-auto bg-white/55 backdrop-blur-xl border border-white/40 rounded-3xl p-7 text-center"
        style="box-shadow: 0 26px 80px -55px rgba(0,0,0,0.22);"
      >
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight text-slate-900">
          Yeni SR Dedektörü
        </h1>
        <p class="text-slate-600 mt-2 text-sm">
          Ne yapmak istiyorsun?
        </p>
    
        <div class="mt-5 grid gap-3 text-left">
          <label class="flex items-center gap-3 p-3 rounded-2xl border border-white/35 bg-white/40 cursor-pointer
                        hover:bg-white/50 transition">
            <input type="radio" name="mode" value="list" checked class="accent-zinc-900">
            <div>
              <div class="font-semibold text-slate-900 text-sm">Yeni SR Listesi</div>
              <div class="text-xs text-slate-600">Sadece yeni gelen SR’ları indir</div>
            </div>
          </label>
    
          <label class="flex items-center gap-3 p-3 rounded-2xl border border-white/35 bg-white/40 cursor-pointer
                        hover:bg-white/50 transition">
            <input type="radio" name="mode" value="newflow" class="accent-zinc-900">
            <div>
              <div class="font-semibold text-slate-900 text-sm">New Flow Şablonu</div>
              <div class="text-xs text-slate-600">OLD/NEW + OUTPUT şablonu indir</div>
            </div>
          </label>
        </div>
    
        <button
          id="startBtn"
          class="mt-5 w-full rounded-2xl bg-gradient-to-b from-zinc-900 to-zinc-800 hover:from-zinc-800 hover:to-zinc-700
                 text-white font-semibold py-2.5 transition shadow-[0_12px_22px_-16px_rgba(0,0,0,0.45)]"
        >
          Devam Et
        </button>
    
        <p class="text-[11px] text-slate-600 mt-3">
          Backend açık olmalı:
          <span class="font-mono text-slate-700">http://127.0.0.1:8000</span>
        </p>
      </div>
    </div>
    

    <!-- APP SCREEN (başlangıçta gizli) -->
    <div id="appScreen" class="hidden">

      <div class="relative mb-10">
        <h1 class="text-3xl md:text-4xl font-semibold tracking-tight text-center text-slate-900">
          Yeni SR Dedektörü
        </h1>

        <div class="absolute right-0 top-1/2 -translate-y-1/2 text-xs text-slate-700
                    bg-white/35 backdrop-blur-xl border border-white/35 rounded-2xl px-4 py-2">
          API: <span class="font-mono text-slate-800">127.0.0.1:8000</span>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-5">

        <!-- Sol: Upload -->
        <div
          class="bg-white/55 backdrop-blur-xl border border-white/40 rounded-3xl p-6"
          style="box-shadow: 0 22px 70px -50px rgba(0,0,0,0.22);"
        >
          <h2 class="text-lg font-medium mb-5 text-slate-900">Dosyalar</h2>

          <label class="block text-sm text-slate-700 mb-2">ESKİ TARİH (.xlsx)</label>
          <input id="oldFile" type="file" accept=".xlsx"
            class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-2xl file:border-0
                   file:bg-zinc-900 file:text-white
                   bg-white/35 rounded-2xl border border-white/35 p-2
                   focus:outline-none focus:ring-2 focus:ring-zinc-300"/>

          <label class="block text-sm text-slate-700 mt-5 mb-2">YENİ TARİH (.xlsx)</label>
          <input id="newFile" type="file" accept=".xlsx"
            class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-2xl file:border-0
                   file:bg-zinc-900 file:text-white
                   bg-white/35 rounded-2xl border border-white/35 p-2
                   focus:outline-none focus:ring-2 focus:ring-zinc-300"/>

          <button
            id="runBtn"
            class="mt-6 w-full rounded-3xl bg-gradient-to-b from-zinc-900 to-zinc-800 hover:from-zinc-800 hover:to-zinc-700
                   text-white font-semibold py-3 transition disabled:opacity-40 disabled:cursor-not-allowed
                   shadow-[0_12px_24px_-16px_rgba(0,0,0,0.45)]"
          >
            Çalıştır ve İndir
          </button>

          <p id="sheetHint" class="text-xs text-slate-600 mt-3">
            Not: Sheet gizli kullanılıyor: <span class="font-mono text-slate-700">Ανατεθειμένες αυτοψίες</span>
          </p>
        </div>

        <!-- Sağ: Durum -->
        <div
          class="bg-white/55 backdrop-blur-xl border border-white/40 rounded-3xl p-6"
          style="box-shadow: 0 22px 70px -50px rgba(0,0,0,0.22);"
        >
          <h2 class="text-lg font-medium mb-4 text-slate-900">Sonuç</h2>

          <div class="grid grid-cols-2 gap-4">
            <div class="rounded-3xl bg-white/35 border border-white/30 p-5">
              <div class="text-xs text-slate-600">Yeni SR sayısı</div>
              <div id="count" class="text-3xl font-semibold mt-2 text-slate-900">-</div>
            </div>
            <div class="rounded-3xl bg-white/35 border border-white/30 p-5">
              <div class="text-xs text-slate-600">Çıktı dosyası</div>
              <div id="outName" class="text-sm text-slate-800 mt-2">YENI_GELEN_SR.xlsx</div>
            </div>
          </div>

          <div class="mt-4 rounded-3xl bg-white/35 border border-white/30 p-5">
            <div class="text-xs text-slate-600">Durum</div>
            <div id="status" class="text-sm text-slate-800 mt-2">Hazır. Dosyaları seçip butona bas.</div>
          </div>

          <div id="errorBox" class="hidden mt-4 rounded-3xl border border-red-200 bg-red-50/90 p-5">
            <div class="text-sm font-semibold text-red-700">Hata</div>
            <div id="errorText" class="text-xs text-red-700 mt-2"></div>
          </div>
        </div>

      </div>
    </div> <!-- appScreen -->

  </div> <!-- container -->

<script>
const API = (location.hostname === "127.0.0.1" || location.hostname === "localhost")
  ? "http://127.0.0.1:8000"
  : "/api";

const SHEET_COMPARE = "Ανατεθειμένες αυτοψίες";
const SHEET_NEWFLOW = "New flow";

const welcomeScreen = document.getElementById("welcomeScreen");
const appScreen = document.getElementById("appScreen");
const startBtn = document.getElementById("startBtn");

const runBtn = document.getElementById("runBtn");
const statusEl = document.getElementById("status");
const countEl = document.getElementById("count");
const outNameEl = document.getElementById("outName");
const sheetHint = document.getElementById("sheetHint");
const errorBox = document.getElementById("errorBox");
const errorText = document.getElementById("errorText");

function getSelectedMode() {
  const el = document.querySelector('input[name="mode"]:checked');
  return el ? el.value : "list";
}
function getSheetForMode(mode) {
  return (mode === "newflow") ? SHEET_NEWFLOW : SHEET_COMPARE;
}
function setStatus(msg) { statusEl.textContent = msg; }
function showError(msg) { errorText.textContent = msg; errorBox.classList.remove("hidden"); }
function clearError() { errorText.textContent = ""; errorBox.classList.add("hidden"); }

function syncUIByMode() {
  const mode = getSelectedMode();
  outNameEl.textContent = (mode === "newflow") ? "NEW_FLOW_SECUNET_TPBE.xlsx" : "YENI_GELEN_SR.xlsx";
  const sheet = getSheetForMode(mode);
  sheetHint.innerHTML = `Not: Sheet gizli kullanılıyor: <span class="font-mono text-slate-700">${sheet}</span>`;
}

function showScreen(screen) {
  if (screen === "app") {
    welcomeScreen.classList.add("hidden");
    appScreen.classList.remove("hidden");
    syncUIByMode();
  } else {
    appScreen.classList.add("hidden");
    welcomeScreen.classList.remove("hidden");
  }
}

document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener("change", syncUIByMode));

startBtn.addEventListener("click", () => {
  history.pushState({ screen: "app" }, "", "#app");
  showScreen("app");
});

window.addEventListener("popstate", () => {
  if (location.hash === "#app") showScreen("app");
  else showScreen("welcome");
});

if (location.hash === "#app") showScreen("app");
else showScreen("welcome");

async function runCompare(endpoint, downloadName, updateCount) {
  clearError();

  const oldFile = document.getElementById("oldFile").files[0];
  const newFile = document.getElementById("newFile").files[0];

  if (!oldFile || !newFile) {
    showError("Lütfen hem ESKİ hem YENİ Excel dosyasını seç.");
    return;
  }

  const mode = getSelectedMode();
  const chosenSheet = getSheetForMode(mode);

  runBtn.disabled = true;
  setStatus("Yükleniyor ve karşılaştırılıyor...");
  if (updateCount) countEl.textContent = "-";

  const form = new FormData();
  form.append("old_file", oldFile);
  form.append("new_file", newFile);
  form.append("sheet_name", chosenSheet);

  try {
    const res = await fetch(`${API}${endpoint}`, { method: "POST", body: form });

    if (!res.ok) {
      const data = await res.json().catch(() => ({}));
      throw new Error(data.error || `Sunucu hatası (${res.status})`);
    }

    if (updateCount) {
      const count = res.headers.get("X-New-SR-Count");
      countEl.textContent = count ? count : "-";
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = downloadName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    setStatus("Tamamlandı. Excel indirildi ✔️");
  } catch (e) {
    setStatus("Hata oluştu ❌");
    showError(e.message);
  } finally {
    runBtn.disabled = false;
  }
}

runBtn.addEventListener("click", () => {
  syncUIByMode();
  const mode = getSelectedMode();
  if (mode === "newflow") runCompare("/compare-newflow", "NEW_FLOW_SECUNET_TPBE.xlsx", true);
  else runCompare("/compare", "YENI_GELEN_SR.xlsx", true);
});
</script>
</body>
</html>
